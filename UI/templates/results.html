{% extends 'index.html' %}

{% block body %}

    <div class="container-fluid">
        <div class="container p-4 my-4 bg-primary text-white text-center rounded" >
            <h2>Case Search</h2>
        </div>
        <form id="fm" action="/search/results" method="post">
            <div class="row justify-content-center">
                <div class="col-4"><input type="text" class="form-control" name="input" value="{{ input }}" placeholder="Search" autofocus></div>        
                <div class="col-4"><button type="submit" class="btn btn-primary">Search</button></div>
            </div> 
        </form>

        <div id="chart" style="width:100%; height:400px;"></div>

        {% if res is defined %}
        <div>
            <h3>{{ res['hits']['total']['value'] }} results found for "{{ input }}"</h3>
        </div>
        <hr>
        <table id="results" class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th class="col-md-1">Year</th>
                    <th class="col-md-1">Case</th>
                    <th class="no-sort col-md-7">Summary</th>
                    <th class="col-md-2">Path</th>
                    <th class="col-md-1">Size</th>
                    <th class="col-md-1">key</th>
                </tr>
            </thead>

            
            <tbody>
                {% for hit in res['hits']['hits'] %}
                <tr>
                    <td>{{ hit['year'] }}</td>
                    <td>{{ hit['case'] }}</td>
                    <td id="{{loop.index}}" name="goodSummary"> {{ hit['good_summary']}} </td>
                    <td> {{ hit['virtual'] }} </td>
                    <td>{{ hit['_source']['file']['filesize'] }}</td>
                    <td>{{ hit['case'] }}###{{ hit['virtual'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
            

        </table>
        {% endif %}
    </div>
    
    {% endblock %}

    {% block scripts %}
    <script  type="text/javascript">
    
        function populateText() {
            var data = document.getElementsByName("goodSummary");
            for (const item of data) {
                item.innerHTML = item.textContent
            }
        }
    
        $(document).ready( function () {
            populateText();

            $('#results').DataTable( {
                "columnDefs": [ 
                    {
                        "targets"  : 'no-sort',
                        "orderable": false,
                        "order": []
                    },
                    {
                        target: 5,
                        visible: false,
                    }
                ]
            });

            drawChart();
        } );

        function drawChart() {
            table = $("#results").DataTable();
        
            var counts = {};
        
            // Count the number of entries for each file
            table
                .column(5, { search: 'applied' })
                .data()
                .each(function (val) {       
                    if (counts[val]) {
                        counts[val] += 1;
                    } else {
                        counts[val] = 1;
                    }
                });
        
            // And map it to the format highcharts uses
            var countMap = $.map(counts, function (val, key) {
                key = key.split("###")[1];
                return {
                    name: key,
                    y: val,
                };
            });
        
        var myChart = Highcharts.chart("chart", {
            chart: {
                type: "pie"
            },
            title: {
                text: "Case to file"
            },
            series: [{
                data: countMap
            }]
        });
        }
        
    </script>
    {% endblock scripts %}
