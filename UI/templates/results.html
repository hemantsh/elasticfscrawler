{% extends 'index.html' %}

{% block body %}

    <div class="container-fluid">
        <div class="container p-4 my-4 bg-primary text-white text-center rounded" >
            <h2>Case Search</h2>
        </div>
        <form id="fm" action="/search/results" method="post">
            <div class="row justify-content-center">
                <div class="col-4"><input type="text" class="form-control" name="input" value="{{ input }}" placeholder="Enter search phrase" autofocus></div>        
                <div class="col-4"><button type="submit" class="btn btn-primary">Search</button></div>
            </div> 
        </form>

        {% if res is defined %}
        <hr>
        <div class="container"  style="height:220px; ">
            <div class="row">
                <div class="col" style="width:200px; height:200px; visibility: hidden;" id="chart1div">
                    <canvas id="chart1"></canvas>
                </div>
                <div class="col"  style="width:200px; height:200px; visibility: hidden;" id="chart2div">
                    <canvas id="chart2"></canvas>
                </div>
                <div class="col" style="width:200px; height:200px; visibility: hidden;" id="chart3div">
                    <canvas id="chart3"></canvas>
                </div>
                <div class="col"  style="width:200px; height:200px; visibility: hidden;" id="chart4div">
                    <canvas id="chart4"></canvas>
                </div>
            </div>
        </div>

        <div>
            <h3>{{ res['hits']['total']['value'] }} results found for "{{ input }}"</h3>
        </div>
        <hr>
        <table id="results" class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th class="col-md-1">Year</th>
                    <th class="col-md-1">Case</th>
                    <th class="no-sort col-md-7">Summary</th>
                    <th class="col-md-1">Path</th>
                    <th class="col-md-1">Size</th>
                    <th class="col-md-1">key</th>
                </tr>
            </thead>

            
            <tbody>
                {% for hit in res['hits']['hits'] %}
                <tr>
                    <td class="col-md-1">{{ hit['year'] }}</td>
                    <td class="col-md-1">{{ hit['case'] }}</td>
                    <td class="col-md-7" id="{{loop.index}}" name="goodSummary"> {{ hit['good_summary']}} </td>
                    <td class="col-md-1"> {{ hit['virtual'] }} </td>
                    <td class="col-md-1">{{ hit['_source']['file']['filesize'] }}</td>
                    <td class="col-md-1">{{ hit['case'] }}###{{ hit['virtual'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
            

        </table>
        {% endif %}
    </div>
    
    {% endblock %}

    {% block scripts %}
    <script  type="text/javascript">
    
        function populateText() {
            var data = document.getElementsByName("goodSummary");
            for (const item of data) {
                item.innerHTML = item.textContent
            }
        }
    
        $(document).ready( function () {
            populateText();

            $('#results').DataTable( {
                "columnDefs": [ 
                    {
                        "targets"  : 'no-sort',
                        "orderable": false,
                        "order": []
                    },
                    {
                        target: 5,
                        visible: false,
                    }
                ],
                "language": {
                    "search": "Filter:",
                    "searchPlaceholder": "Enter filter text"
                },

                dom: 'Bfrtip',
                buttons: [
                    'pageLength',
                    'copyHtml5',
                    'excelHtml5',
                    'csvHtml5',
                    'pdfHtml5',
                    'print'
                ],
                lengthMenu: [
                    [ 10, 25, 50, 100, -1 ],
                    [ '10 rows', '25 rows', '50 rows', '100 rows', 'Show all' ]
                ]
            });

            mychart();
        } );

        function mychart() {
            var casefiles = {};
            var table = $('#results').DataTable();
            table
                .column(5, { search: 'applied' })
                .data()
                .each(function (val) {    
                    parts = val.split("###");  
                    caseNum = parts[0]; 
                    if (casefiles[caseNum]) {
                        casefiles[caseNum].push( parts[1] );
                    } else {
                        casefiles[caseNum] = [];
                        casefiles[caseNum].push( parts[1] );
                    }
                });

                casefiles['sharma'] = ["a","b","c"];
                
                var datasets = {};
                

                Object.keys(casefiles).forEach ( function(val) {
                    datasets[val] = $.map(casefiles[val], function (value) {
                
                        return {
                            name: value,
                            y: 1,
                        };
                    });
                });
                
                var i = 1;
                Object.keys(datasets).forEach ( function( key) {
                    charting(i, key, datasets[key]);
                    i++;
                });
        }

        function charting( index , caseid , dataset ) {
            
            const ctx = document.getElementById('chart'+index);
            document.getElementById('chart'+index+'div').style.visibility = 'visible';
            

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataset.map(row => row.name),
                    datasets: [
                    {
                        label: caseid,
                        data: dataset.map(row => row.y)
                    }
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            position: 'bottom',
                            text: "Case: "+caseid
                        },
                        colors: {
                            enabled: false
                        }
                    }
                }
            });
        }
        
    </script>
    {% endblock scripts %}
